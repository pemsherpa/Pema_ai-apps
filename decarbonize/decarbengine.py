# -*- coding: utf-8 -*-
"""DecarbEngine.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EWIicIg05wODK4aX-Dk-DY5WdoQz968r
"""

from components.biz_commute_analyzer import BusinessCommutingAnalyzer
from components.electricity.optimization_calculation.electricity_work import ElectricityWork
from components.electricity.optimization_calculation.lcbelectricityrateplan import LCBElectricityRatePlan
from components.electricity.optimization_calculation.lcuelectricityrateplan import LCUElectricityRatePlan
from components.electricity.optimization_calculation.smuelectricityrateplan import SMUElectricityRatePlan
from components.electricity.optimization_calculation.smbelectricityrateplan import SMBElectricityRatePlan
from components.electricity.current_price_calculation.current_electricity import CurrentElectricity
from components.electricity.current_price_calculation.currentlcbelectricityrateplan import currentLCBElectricityRatePlan
from components.electricity.current_price_calculation.currentsmbelectricityrateplan import currentSMBElectricityRatePlan
from steps.electric_decarb_step import ElectricDecarbStep
from components.electricity.sectors.lcbsector import LCBSector
from components.electricity.sectors.lcusector import LCUSector
from components.electricity.sectors.smbsector import SMBSector
from components.electricity.sectors.smusector import SMUSector
from components.flight_data_analyzer import FlightDataAnalyzer
from steps.decarb_step import DecarbStep
from steps.decarb_step_type import DecarbStepType
from steps.decarb_weight import DecarbWeight
import pandas as pd
from steps.flight_decarb_step import FlightDecarbStep

class DecarbEngine:
    def __init__(self, commuting_data,dynamic_data, origin, destination, departure_date,firm,weights,return_date=None):
        self.GOOGLE_MAPS_API_KEY = "AIzaSyD1fbsNKLIWwHly5YcSBcuMWhYd2kTIN08"
        self.FLIGHT_API_KEY = '7b97097f97bcea06b3c9c8b81e864da1f686069cdfba1dfd89834eec702b8f16'
        self.OIL_PRICE_API_KEY = 'jDLAcmPbuXd1CMXRjKFZMliukSgC6ujhUjnKaxOf'
        self.firm = firm
        self.dynamic = dynamic_data
        self.weights = weights

        self.commuting_analyzer = BusinessCommutingAnalyzer(commuting_data, self.GOOGLE_MAPS_API_KEY, self.OIL_PRICE_API_KEY,self.firm,self.dynamic)
        self.flight_analyzer = FlightDataAnalyzer(self.FLIGHT_API_KEY,self.weights, origin, destination, departure_date, return_date)
        self.steps = []

    def analyze_commuting_costs(self):
        return self.commuting_analyzer.calculate_current_costs_and_emissions()

    def analyze_flight_costs(self):
        return self.flight_analyzer.get_optimal_flight(self.flight_analyzer.df_all_flights)

    def get_return_flight_options(self):
        return self.flight_analyzer.get_return_tickets()

    def compare_flight_stops(self):
       return self.flight_analyzer.compare_stops()

    def non_economy_cheaper_than_economy(self):
       return self.flight_analyzer.non_economy_cheaper_than_economy()

    def get_price_insights(self):
       return self.flight_analyzer.price_insights()

    def run_decarb_engine(self):
        savings = 0

        # commuting costs and emissions for individual
        commuting_costs, commuting_emissions = self.analyze_commuting_costs()
        commuting_step = DecarbStep(
            step_type=DecarbStepType.COMMUTING,
            cur_cost=commuting_costs,

            new_cost=self.commuting_analyzer.stipent_individual(self.commuting_analyzer.commuting_data,self.commuting_analyzer.firm_location, 1,
                                                                 50, 2,30)[2],
            cur_emissions=commuting_emissions,
            new_emissions=commuting_emissions * 0.9,  # fake num
            description="Analyze commuting costs and emissions for individual",
            ranking_zscore=1.0
        )
        self.steps.append(commuting_step)
        savings += commuting_step.compute_savings()

        # commuting cost for carpool
        commuting_costs, commuting_emissions = self.analyze_commuting_costs()
        commuting_step = DecarbStep(
            step_type=DecarbStepType.COMMUTING,
            cur_cost=commuting_costs,
            new_cost = self.commuting_analyzer.carpool_savings(self.commuting_analyzer.commuting_data,self.commuting_analyzer.firm_location,
                                                                       [1,2,3], 50,2,30)[0],
            new_emissions = self.commuting_analyzer.carpool_savings(self.commuting_analyzer.commuting_data,self.commuting_analyzer.firm_location,
                                                                       [1,2,3], 50,2,30)[2],
            cur_emissions=commuting_emissions,
            description="Analyze commuting costs and emissions for carpool", 
            difficulty= 3
        )
        self.steps.append(commuting_step)
        savings += commuting_step.compute_savings()
        
        #flight costs
        optimal_flight = self.analyze_flight_costs()
        print(optimal_flight)
        flight_step = self.create_flight_step(optimal_flight, 3)
        self.steps.append(flight_step)
        savings += flight_step.compute_savings()

        # return flight
        return_flight = self.get_return_flight_options()
        return_flight_step = self.create_flight_step(return_flight, 3.5)
        self.steps.append(return_flight_step)
        savings += return_flight_step.compute_savings()

        
    def create_flight_step(self, return_flight, difficulty):
        return_flight_savings = return_flight['Price'].iloc[0]
        return_flight_emissions = return_flight['Carbon Emissions'].iloc[0]
        return_flight_step = FlightDecarbStep(
            cur_cost=return_flight_savings * 1.1, # fake
            new_cost=return_flight_savings,
            cur_emissions=return_flight_emissions * 1.1, # fake
            new_emissions=return_flight_emissions,
            description="Analyze return flight costs and emissions",
            num_stops=return_flight['Stops'].iloc[0],
            difficulty=difficulty
        )
        return return_flight_step

    
    def run_electric():
        user_zip_code = 94002 #95948
        user_sector = 'Small and Medium Business'#'Large Commercial and Industrial'
        user_bundled = 'Yes'
        user_current_plan = 'B-1'#'B19TVB'
        kwh_used = 10000
        user_cur_cost = 100000
        difficulty = 2
        user_cur_renewable = 0.1
        ranking_zscore = 10

        user_current_company = "PG&E"
        user_cost_weight = 0.6
        user_renewable_weight = 0.4 

        UseCCA = 'Yes'
        HasCCA = 'Yes'

        lcb_usage_data = LCBSector(162, 76, 181, 101, 61, 37, 9, 78, 65, 13, 29,
                                    161, 25, 34, 112, 143, 15, 78, 134, 92, 67, 67,
                                    110, 6, 35, 154, 28, 153, 132, 127, 12, 30, 191,
                                    50, 38, 199, 80, 155, 1)
        smb_usage_data = SMBSector(21, 96, 50, 170, 38, 180, 190, 176, 139, 9, 47, 149, 
                                    64, 113, 169, 159, 64, 162, 158, 166, 57, 45, 38, 168, 
                                    131, 194, 24, 79, 35, 115, 12, 195, 180, 173, 143, 129, 
                                    96, 89, 46, 180, 91, 62, 45, 12, 19, 174, 79)
        lcu_usage_data = LCUSector(162, 76, 181, 101, 61, 37, 9, 78, 65, 13, 29,
                                    161, 25, 34, 112, 143, 15, 78, 134, 92, 67, 67,
                                    110, 6, 35, 154, 28, 153, 132, 127, 12, 30, 191,
                                    50, 38, 199, 80, 155, 1, 99, 14, 118, 141, 121, 
                                    31, 198, 108, 44, 54, 22, 31)
        smu_usage_data = SMUSector(21, 96, 50, 170, 38, 180, 190, 176, 139, 9, 47, 149, 
                                    64, 113, 169, 159, 64, 162, 158, 166, 57, 45, 38, 168, 
                                    131, 194, 24, 79, 35, 115, 12, 195, 180, 173, 143, 129, 
                                    96, 89, 46, 180, 91, 62, 45, 12, 19, 174, 79)

        test = ElectricDecarbStep(user_cur_cost, kwh_used, user_zip_code, user_sector, user_bundled, user_current_company, 
                                user_current_plan, user_cost_weight,user_renewable_weight, UseCCA, HasCCA, lcb_usage_data, smb_usage_data, lcu_usage_data, 
                                smu_usage_data, ranking_zscore)
        CES = test.compute_electricbill_savings() 
        Carbon_Saving = test.get_new_carbon_from_electric()   
        return CES, Carbon_Saving
        

        

# Defining main function 
   
    def run_commute_and_flight():
        origin = "LAX"
        destination = "JFK"
        departure_date = "2024-07-01"
        return_date = "2024-07-10"
        firm = '2107 Addison St, Berkeley, CA'
        commuting_data = pd.DataFrame({
            'ID': [1, 2, 3],
            'method':['car','uber','car'],
            'locations':['1122 University Ave, Berkeley, CA','2010 Fifth St, Berkeley, CA','3006 San Pablo Ave, Berkeley, CA '],
            'frequency': [22, 20, 18],
            'cost_per_km':[0.1,0.2,0.3]
        })

        df_dynamic = pd.DataFrame({
            'method': ['bus', 'train', 'uber'],
            'distance': [10, 10, 10],
            'cost_per_km': [0.1, 0.2, 0.7]
        })

        weights =  DecarbWeight(0.4, 0.3, 0.2, 0.1) 
        decarb_engine = DecarbEngine(commuting_data, df_dynamic,origin, destination, departure_date, firm, weights,return_date)
        decarb_steps = decarb_engine.run_decarb_engine()

        for step in decarb_steps:
            print(step.generate_step_description())
            print(f"Savings: ${step.compute_savings()}")
            print(f"Emissions Savings: {step.compute_emissions_savings()} kg CO2\n")

def main():
    #DecarbEngine.run_commute_and_flight()
    print(DecarbEngine.run_electric()) 
        
if __name__ == "__main__":
    main()
        
